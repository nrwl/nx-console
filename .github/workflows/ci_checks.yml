name: CI Checks
on:
  push:
    branches:
      - master
  pull_request:

env:
  NODE_VERSION: 24
  JAVA_VERSION: 21
  NX_CLOUD_NO_TIMEOUTS: true
  NX_PLUGIN_NO_TIMEOUTS: true
  NX_CLOUD_ACCESS_TOKEN: ${{ github.ref == 'refs/heads/master' && secrets.NX_CLOUD_READ_WRITE_TOKEN || secrets.NX_CLOUD_READ_TOKEN }}

jobs:
  main-linux:
    name: Main Linux
    runs-on: ubuntu-latest
    env:
      NX_BATCH_MODE: true
      NX_CI_EXECUTION_ENV: 'linux'
      NX_VERBOSE_LOGGING: true
      GIT_AUTHOR_EMAIL: test@test.com
      GIT_AUTHOR_NAME: Test
      GIT_COMMITTER_EMAIL: test@test.com
      GIT_COMMITTER_NAME: Test
    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: false
          swap-storage: false

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: 'master'

      - run: git branch --track master origin/master
        if: ${{ github.event_name == 'pull_request' }}

      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          check-latest: true
          cache: yarn

      - name: Start the Nx Cloud CI Run
        run: |
          yarn dlx nx-cloud start-ci-run --distribute-on=".nx/workflows/linux-distribution-config.yaml" --with-env-vars="GIT_AUTHOR_EMAIL,GIT_AUTHOR_NAME,GIT_COMMITTER_EMAIL,GIT_COMMITTER_NAME,NX_CI_EXECUTION_ENV,NX_VERBOSE_LOGGING,JAVA_VERSION"

      - name: Gradle Wrapper Validation
        uses: gradle/actions/wrapper-validation@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: zulu
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-home-cache-excludes: |
            caches/*/transforms

      - name: Ensure Nx Cloud Agents are configured correctly
        run: yarn dlx nx-cloud validate --workflow-file=./.nx/workflows/agents.yaml

      - uses: browser-actions/setup-chrome@v1

      - run: chrome --version

      - name: Install NPM dependencies
        run: yarn install --immutable

      - name: Setup Gradle Dependencies
        run: ./gradlew dependencies

      - name: Check formatting
        run: |
          yarn nx-cloud record -- yarn nx format:check --verbose
          yarn nx-cloud record -- yarn nx run-many -t ktfmtFormat

      - name: Ensure the workspace configuration is in sync
        run: yarn nx-cloud record -- yarn nx sync:check

      # - name: Run Nx Cloud conformance checks
      #   run: yarn nx-cloud record -- yarn nx-cloud conformance:check

      - name: Disk Space Report (Pre-Build)
        run: |
          echo "=== DISK SPACE REPORT (PRE-BUILD) ==="
          df -h
          echo ""
          echo "--- ~/.gradle top-level breakdown ---"
          du -sh ~/.gradle 2>/dev/null || echo "~/.gradle not found"
          du -sh ~/.gradle/*/ 2>/dev/null | sort -rh || true
          echo ""
          echo "--- ~/.gradle/caches breakdown ---"
          du -sh ~/.gradle/caches/*/ 2>/dev/null | sort -rh || true
          echo ""
          echo "--- IntelliJ IDE copies in transforms (look for duplicates) ---"
          find ~/.gradle/caches -maxdepth 4 -type d -name "ideaI*" 2>/dev/null || echo "no ideaI* dirs found"
          find ~/.gradle/caches -maxdepth 4 -type d -name "transformed" 2>/dev/null | while read d; do
            echo "  $d:"
            du -sh "$d"/* 2>/dev/null | sort -rh | head -5
          done
          echo ""
          echo "--- IntelliJ IDE ZIPs/archives in modules-2 ---"
          find ~/.gradle/caches/modules-2 -name "*idea*" -o -name "*intellij*" 2>/dev/null | head -20 || true
          du -sh ~/.gradle/caches/modules-2/files-2.1/com.jetbrains.intellij.idea 2>/dev/null || echo "no idea module dir"
          echo ""
          echo "--- All dirs > 1GB in ~/.gradle ---"
          du -h ~/.gradle 2>/dev/null | awk '$1 ~ /G/ && $1+0 >= 1' | sort -rh | head -20 || true
          echo ""
          echo "--- Top-level disk usage ---"
          du -sh /* 2>/dev/null | sort -rh | head -15
          echo ""
          echo "--- /home breakdown ---"
          du -sh /home/*/ 2>/dev/null | sort -rh || true
          du -sh /home/runner/*/ 2>/dev/null | sort -rh | head -15 || true
          echo "=== END DISK SPACE REPORT ==="

      # todo(cammisuli): disable verifyPlugin for now as its constantly failing on CI
      # - run: yarn nx affected --targets=lint,test,build,e2e-ci,typecheck,verifyPlugin,telemetry-check --configuration=ci --exclude=nx-console --parallel=3
      - run: yarn nx affected --targets=lint,test,build,e2e-ci,typecheck,telemetry-check,buildPlugin --configuration=ci --exclude=nx-console --parallel=3
        timeout-minutes: 60

      - name: Disk Space Report (Post-Build)
        if: always()
        run: |
          echo "=== DISK SPACE REPORT (POST-BUILD) ==="
          df -h
          echo ""
          echo "--- ~/.gradle top-level breakdown ---"
          du -sh ~/.gradle 2>/dev/null || echo "~/.gradle not found"
          du -sh ~/.gradle/*/ 2>/dev/null | sort -rh || true
          echo ""
          echo "--- ~/.gradle/caches breakdown ---"
          du -sh ~/.gradle/caches/*/ 2>/dev/null | sort -rh || true
          echo ""
          echo "--- IntelliJ IDE copies in transforms (look for duplicates) ---"
          find ~/.gradle/caches -maxdepth 4 -type d -name "ideaI*" 2>/dev/null || echo "no ideaI* dirs found"
          for d in $(find ~/.gradle/caches -maxdepth 4 -type d -name "ideaI*" 2>/dev/null); do
            du -sh "$d"
          done
          echo ""
          echo "--- All transformed dirs with sizes ---"
          find ~/.gradle/caches -maxdepth 3 -type d -name "transformed" 2>/dev/null | while read d; do
            echo "  $d:"
            du -sh "$d"/* 2>/dev/null | sort -rh | head -10
          done
          echo ""
          echo "--- IntelliJ IDE ZIPs/archives in modules-2 ---"
          find ~/.gradle/caches/modules-2 -name "*idea*" -o -name "*intellij*" 2>/dev/null | head -30 || true
          echo ""
          echo "--- All dirs > 1GB in ~/.gradle ---"
          du -h ~/.gradle 2>/dev/null | awk '$1 ~ /G/ && $1+0 >= 1' | sort -rh | head -20 || true
          echo ""
          echo "--- /home/runner breakdown ---"
          du -sh /home/runner/*/ 2>/dev/null | sort -rh | head -15 || true
          echo ""
          echo "--- node_modules size ---"
          du -sh node_modules 2>/dev/null || true
          echo ""
          echo "--- .nx/cache size ---"
          du -sh .nx/cache 2>/dev/null || true
          echo ""
          echo "--- Top-level disk usage ---"
          du -sh /* 2>/dev/null | sort -rh | head -15
          echo "=== END DISK SPACE REPORT ==="

      - run: npx nx-cloud fix-ci
        if: failure()

  # main-windows:
  #   name: Main Windows
  #   runs-on: windows-latest
  #   env:
  #     GIT_AUTHOR_EMAIL: test@test.com
  #     GIT_AUTHOR_NAME: Test
  #     GIT_COMMITTER_EMAIL: test@test.com
  #     GIT_COMMITTER_NAME: Test
  #     NX_CI_EXECUTION_ENV: 'windows'
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - uses: nrwl/nx-set-shas@v4
  #       with:
  #         main-branch-name: 'master'

  #     - run: git branch --track master origin/master
  #       if: ${{ github.event_name == 'pull_request' }}

  #     - name: Use Node.js ${{ env.NODE_VERSION }}
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         check-latest: true
  #         cache: yarn

  #     - name: Start the Nx Cloud CI Run
  #       run: |
  #         yarn dlx nx-cloud start-ci-run --distribute-on=".nx/workflows/windows-distribution-config.yaml" --with-env-vars="GIT_AUTHOR_EMAIL,GIT_AUTHOR_NAME,GIT_COMMITTER_EMAIL,GIT_COMMITTER_NAME,JAVA_VERSION,NODE_OPTIONS"

  #     - uses: browser-actions/setup-chrome@v1

  #     - name: Install NPM dependencies
  #       run: yarn install --immutable

  #     - name: Gradle Wrapper Validation
  #       uses: gradle/actions/wrapper-validation@v3

  #     - name: Setup Java
  #       uses: actions/setup-java@v3
  #       with:
  #         distribution: zulu
  #         java-version: ${{ env.JAVA_VERSION }}
  #         cache: gradle

  #     # There's no need to check formatting, linting & typecheck again on windows
  #     - run: yarn nx affected --targets="build,test,e2e-ci" --configuration=ci --exclude=nx-console --parallel=3 --verbose
  #       timeout-minutes: 60
  #       env:
  #         NX_VERBOSE_LOGGING: true
  #         NODE_OPTIONS: --max-old-space-size=4096
