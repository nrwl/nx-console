common-env: &common-env
  NX_VERBOSE_LOGGING: true
common-init-steps: &common-init-steps
  - name: Checkout
    uses: 'nrwl/nx-cloud-workflows/v4/workflow-steps/checkout/main.yaml'
  - group-name: Restore Caches
    steps:
      - name: Setup Java 21
        script: |
          sudo apt update
          sudo apt install -y openjdk-21-jdk
          sudo update-alternatives --set java /usr/lib/jvm/java-21-openjdk-amd64/bin/java
          java -version
      - name: Restore Node Modules Cache
        uses: 'nrwl/nx-cloud-workflows/v4/workflow-steps/cache/main.yaml'
        inputs:
          key: 'package-lock.json|yarn.lock|pnpm-lock.yaml'
          paths: 'node_modules'
          base-branch: 'main'
      - name: Restore Browser Binary Cache
        uses: 'nrwl/nx-cloud-workflows/v4/workflow-steps/cache/main.yaml'
        inputs:
          key: 'package-lock.json|yarn.lock|pnpm-lock.yaml|"browsers"'
          paths: |
            '../.cache/Cypress'
          base-branch: 'main'
  - group-name: Install Dependencies
    steps:
      - name: Install Node Modules
        uses: 'nrwl/nx-cloud-workflows/v4/workflow-steps/install-node-modules/main.yaml'
      - name: Generate workspace data
        script: npx nx show projects
  - name: Install Browsers
    uses: 'nrwl/nx-cloud-workflows/v4/workflow-steps/install-browsers/main.yaml'
  - name: Disk Space Report (Pre-Build)
    script: |
      echo "=== DISK SPACE REPORT (PRE-BUILD) ==="
      echo "--- df -h ---"
      df -h
      echo ""
      echo "--- Large directories in HOME ---"
      du -sh ~/.gradle 2>/dev/null || echo "~/.gradle not found"
      du -sh ~/.gradle/caches 2>/dev/null || echo "~/.gradle/caches not found"
      du -sh ~/.gradle/caches/modules-2 2>/dev/null || echo "~/.gradle/caches/modules-2 not found"
      du -sh ~/.cache/intellij-platform 2>/dev/null || echo "~/.cache/intellij-platform not found"
      du -sh ~/.local/share/JetBrains 2>/dev/null || echo "~/.local/share/JetBrains not found"
      echo ""
      echo "--- Top-level disk usage ---"
      du -sh /* 2>/dev/null | sort -rh | head -20
      echo ""
      echo "--- Workspace dist directory ---"
      du -sh dist 2>/dev/null || echo "dist/ not found"
      echo "=== END DISK SPACE REPORT ==="

launch-templates:
  linux-medium-plus-js:
    resource-class: 'docker_linux_amd64/medium+'
    image: 'ubuntu22.04-node20.11-v10'
    env: *common-env
    init-steps: *common-init-steps
  linux-large-plus-js:
    resource-class: 'docker_linux_amd64/large+'
    image: 'ubuntu22.04-node20.11-v10'
    env: *common-env
    init-steps: *common-init-steps
  # windows-medium-js:
  #   resource-class: 'windows/medium'
  #   image: 'windows-2022'
  #   init-steps:
  #     - name: Checkout
  #       uses: 'nrwl/nx-cloud-workflows/v4/workflow-steps/checkout/main.yaml'
  #     - name: Restore Node Modules Cache
  #       uses: 'nrwl/nx-cloud-workflows/v4/workflow-steps/cache/main.yaml'
  #       inputs:
  #         key: 'package-lock.json|yarn.lock|pnpm-lock.yaml'
  #         paths: 'node_modules'
  #         base-branch: 'main'
  #     - name: Restore Browser Binary Cache
  #       uses: 'nrwl/nx-cloud-workflows/v4/workflow-steps/cache/main.yaml'
  #       inputs:
  #         key: 'package-lock.json|yarn.lock|pnpm-lock.yaml|"browsers"'
  #         paths: |
  #           '../.cache/Cypress'
  #           '../.cache/ms-playwright'
  #         base-branch: 'main'
  #     - name: Install Node Modules
  #       uses: 'nrwl/nx-cloud-workflows/v4/workflow-steps/install-node-modules/main.yaml'
  #     - name: Install Browsers (if needed)
  #       uses: 'nrwl/nx-cloud-workflows/v4/workflow-steps/install-browsers/main.yaml'
  #     - name: Install cypress with --force
  #       script: npx cypress install --force
